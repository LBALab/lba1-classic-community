name: CMake Release Build

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0
  workflow_dispatch:  # Allows manual trigger
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  build-and-release:
    runs-on: macos-13  # macOS Intel (x86_64)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog generation

      - name: Install dependencies
        run: |
          brew install cmake ninja

      - name: Setup Open Watcom v2.0
        run: |
          echo "Downloading and installing Open Watcom for macOS..."
          cd /tmp
          
          # List available assets to find the correct filename
          echo "Checking available OpenWatcom releases..."
          curl -s https://api.github.com/repos/open-watcom/open-watcom-v2/releases/tags/Current-build | \
            grep "browser_download_url.*osx" || echo "No macOS assets found"
          
          # Try the correct asset name (likely has .tar.gz extension)
          echo "Downloading from GitHub releases..."
          curl -L -o watcom.tar.gz \
            https://github.com/open-watcom/open-watcom-v2/releases/download/Current-build/open-watcom-2_0-c-osx-x64 \
            --fail || \
          curl -L -o watcom.tar.gz \
            https://github.com/open-watcom/open-watcom-v2/releases/download/Current-build/ow-snapshot.tar.gz \
            --fail || \
          {
            echo "ERROR: Could not download OpenWatcom"
            echo "Available assets in Current-build release:"
            curl -s https://api.github.com/repos/open-watcom/open-watcom-v2/releases/tags/Current-build | \
              grep "browser_download_url" | grep -i "osx\|mac" || echo "No macOS assets found"
            exit 1
          }
          
          echo "Downloaded file info:"
          file watcom.tar.gz
          ls -lh watcom.tar.gz
          
          # Verify we got a real archive (should be > 10MB)
          FILE_SIZE=$(stat -f%z watcom.tar.gz)
          if [ "$FILE_SIZE" -lt 1000000 ]; then
            echo "ERROR: Downloaded file is too small ($FILE_SIZE bytes)"
            echo "File contents:"
            head -20 watcom.tar.gz
            exit 1
          fi
          
          # Create installation directory
          sudo mkdir -p /opt/watcom
          
          # Extract the archive
          echo "Extracting archive..."
          sudo tar -xzf watcom.tar.gz -C /opt/watcom
          
          echo "Checking installation..."
          ls -la /opt/watcom
          
          # Find the actual installation directory (might be nested)
          if [ -d "/opt/watcom/watcom" ]; then
            echo "Found nested watcom directory, moving files..."
            sudo mv /opt/watcom/watcom/* /opt/watcom/
            sudo rmdir /opt/watcom/watcom
          fi
          
          # Check if files are in a subdirectory
          SUBDIR_COUNT=$(sudo find /opt/watcom -maxdepth 1 -type d | wc -l)
          if [ "$SUBDIR_COUNT" -eq 2 ]; then
            SUBDIR=$(sudo find /opt/watcom -maxdepth 1 -mindepth 1 -type d)
            echo "Found single subdirectory: $SUBDIR"
            echo "Moving contents up..."
            sudo mv "$SUBDIR"/* /opt/watcom/
            sudo rmdir "$SUBDIR"
          fi
          
          echo "Final installation structure:"
          ls -la /opt/watcom
          echo ""
          echo "Looking for binaries:"
          sudo find /opt/watcom -name "wcc386" -o -name "wasm" -o -name "wlink" | head -5

      - name: Discover and setup Open Watcom environment
        run: |
          echo "Searching for Open Watcom installation..."
          
          # Unset WATCOM if it's set to a URL (from setup-watcom action)
          if [[ "$WATCOM" == http* ]]; then
            echo "Clearing invalid WATCOM URL: $WATCOM"
            unset WATCOM
          fi
          
          # Try to find WATCOM installation in common locations
          if [ -d "/opt/watcom" ]; then
            WATCOM_ROOT="/opt/watcom"
          elif [ -d "$HOME/watcom" ]; then
            WATCOM_ROOT="$HOME/watcom"
          elif [ -d "/usr/local/watcom" ]; then
            WATCOM_ROOT="/usr/local/watcom"
          elif [ -d "$GITHUB_WORKSPACE/watcom" ]; then
            WATCOM_ROOT="$GITHUB_WORKSPACE/watcom"
          else
            echo "ERROR: Cannot find Open Watcom installation"
            echo "Searched locations:"
            echo "  /opt/watcom"
            echo "  $HOME/watcom"
            echo "  /usr/local/watcom"
            echo "  $GITHUB_WORKSPACE/watcom"
            echo ""
            echo "Contents of common directories:"
            ls -la /opt/ 2>/dev/null || echo "  /opt/ not accessible"
            ls -la "$HOME" | grep -i watcom || echo "  No watcom in HOME"
            exit 1
          fi
          
          echo "Found WATCOM at: $WATCOM_ROOT"
          ls -la "$WATCOM_ROOT" || true
          
          # Determine correct bin directory
          if [ -d "$WATCOM_ROOT/bino64" ]; then
            BIN_DIR="$WATCOM_ROOT/bino64:$WATCOM_ROOT/bino"
          elif [ -d "$WATCOM_ROOT/binl64" ]; then
            BIN_DIR="$WATCOM_ROOT/binl64:$WATCOM_ROOT/binl"
          elif [ -d "$WATCOM_ROOT/bin" ]; then
            BIN_DIR="$WATCOM_ROOT/bin"
          else
            echo "ERROR: Cannot find bin directory in WATCOM installation"
            ls -la "$WATCOM_ROOT"
            exit 1
          fi
          
          # Determine correct header directory
          if [ -d "$WATCOM_ROOT/h" ]; then
            INCLUDE_DIR="$WATCOM_ROOT/h"
          elif [ -d "$WATCOM_ROOT/lh" ]; then
            INCLUDE_DIR="$WATCOM_ROOT/lh"
          else
            echo "WARNING: Cannot find header directory, using default"
            INCLUDE_DIR="$WATCOM_ROOT/h"
          fi
          
          echo "WATCOM=$WATCOM_ROOT" >> $GITHUB_ENV
          echo "PATH=$BIN_DIR:$PATH" >> $GITHUB_ENV
          echo "INCLUDE=$INCLUDE_DIR" >> $GITHUB_ENV
          echo "EDPATH=$WATCOM_ROOT/eddat" >> $GITHUB_ENV
          echo "WIPFC=$WATCOM_ROOT/wipfc" >> $GITHUB_ENV
          
          echo "Environment configured:"
          echo "  WATCOM=$WATCOM_ROOT"
          echo "  BIN_DIR=$BIN_DIR"
          echo "  INCLUDE=$INCLUDE_DIR"

      - name: Verify Open Watcom installation
        run: |
          echo "Checking Open Watcom installation..."
          echo "WATCOM=$WATCOM"
          echo "PATH=$PATH"
          
          which wcc386 || echo "wcc386 not found in PATH"
          which wasm || echo "wasm not found in PATH"
          which wlink || echo "wlink not found in PATH"
          
          echo ""
          echo "Listing WATCOM directory structure:"
          ls -la "$WATCOM" || true

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "push" ] && [ -n "${{ github.ref_name }}" ]; then
            # Tag push: use tag name (remove 'v' prefix if present)
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger: use input version
            VERSION="${{ github.event.inputs.version }}"
          else
            # Fallback: use project version from CMakeLists.txt
            VERSION=$(grep "VERSION" CMakeLists.txt | head -1 | sed 's/.*VERSION \([0-9.]*\).*/\1/')
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Configure CMake
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_DOS=ON \
            -DCMAKE_TOOLCHAIN_FILE=cmake/toolchains/openwatcom.cmake

      - name: Build DOS executable
        run: |
          cmake --build build --target LBAD --verbose

      - name: Prepare release artifacts
        run: |
          mkdir -p release/lba1-classic-dos-${{ steps.version.outputs.VERSION }}
          
          # Copy executable
          cp build/bin/LBAD.exe release/lba1-classic-dos-${{ steps.version.outputs.VERSION }}/
          
          # Copy CSV files if they exist
          if [ -d "SOURCES/assets" ]; then
            cp SOURCES/assets/*.csv release/lba1-classic-dos-${{ steps.version.outputs.VERSION }}/ 2>/dev/null || true
          fi
          
          # Copy documentation
          cp README.md release/lba1-classic-dos-${{ steps.version.outputs.VERSION }}/ || true
          cp LICENSE release/lba1-classic-dos-${{ steps.version.outputs.VERSION }}/ || true
          
          # Create a version info file
          cat > release/lba1-classic-dos-${{ steps.version.outputs.VERSION }}/VERSION.txt << EOF
          LBA1 Classic Community Edition
          Version: ${{ steps.version.outputs.VERSION }}
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          EOF
          
          # Create ZIP archive
          cd release
          zip -r lba1-classic-dos-${{ steps.version.outputs.VERSION }}.zip lba1-classic-dos-${{ steps.version.outputs.VERSION }}
          cd ..

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found, generating full changelog"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "Generating changelog from $PREV_TAG to HEAD"
            CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          # Save changelog to file
          cat > CHANGELOG.md << EOF
          ## What's Changed
          
          $CHANGELOG
          
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${{ github.ref_name }}
          EOF
          
          # Output for GitHub release
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          cat CHANGELOG.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lba1-classic-dos-${{ steps.version.outputs.VERSION }}
          path: release/lba1-classic-dos-${{ steps.version.outputs.VERSION }}.zip
          retention-days: 30

      - name: Create GitHub Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          name: LBA1 Classic v${{ steps.version.outputs.VERSION }}
          body: ${{ steps.changelog.outputs.CHANGELOG }}
          draft: false
          prerelease: false
          files: |
            release/lba1-classic-dos-${{ steps.version.outputs.VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release (Manual)
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          name: LBA1 Classic v${{ steps.version.outputs.VERSION }}
          tag_name: v${{ steps.version.outputs.VERSION }}
          body: |
            ## Manual Release
            
            ${{ steps.changelog.outputs.CHANGELOG }}
            
            This release was created manually via workflow dispatch.
          draft: true
          prerelease: false
          files: |
            release/lba1-classic-dos-${{ steps.version.outputs.VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
